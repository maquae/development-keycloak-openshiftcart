#!/bin/bash -eu

# Determine the program name and the 'running directory'
IAM="${0##*/}"
CRD="$( [[ "${0:0:2}" = "./" ]] &&
  {    printf "${PWD}/${0#./}"
 } || {
        printf "${0}"
 })"
CRD="${CRD%/*}"
CUR="${PWD}"

# Make sure all language settings are correct
export LANG=C

# Save the shell settings
SETA=0; [[ ${-} = *a* ]] && SETA=1
SETE=0; [[ ${-} = *e* ]] && SETE=1
SETU=0; [[ ${-} = *u* ]] && SETU=1
SETX=0; [[ ${-} = *x* ]] && SETX=1

# Set and unset the needed shell settings
set +o noclobber          # Overwrite existing files, if needed
set -o nounset               # Don't allow uninitialized variables
set +o errexit              # No returncode checking

# Set the PATH
PATH=/bin:/usr/bin:${PATH}

# Read the OpenShift functions
source ${OPENSHIFT_CARTRIDGE_SDK_BASH}

# Set constants and read constants
LIBDIR="${CRD}/../lib"
LIBRARY="${LIBDIR}/library"
[[ ! -r ${LIBRARY} ]] && { echo "${LIBRARY} not found"; exit 1; }
. ${LIBRARY} || { echo "Error reading ${LIBRARY}"; exit 1; }

case "$1" in
  -v|--version)
    version="$2"
esac

# Create additional directories required by JBOSSAS
mkdir -p ${OPENSHIFT_HOMEDIR}/.m2
mkdir -p ${OPENSHIFT_WILDFLY_DIR}/{template,standalone/tmp,standalone/deployments,standalone/configuration,standalone/log,standalone/data}

# Copy the version specific files up to jbossas directory
cp -r ${OPENSHIFT_WILDFLY_DIR}versions/${version}/standalone/configuration/* ${OPENSHIFT_WILDFLY_DIR}standalone/configuration
cp -r ${OPENSHIFT_WILDFLY_DIR}versions/${version}/bin/* ${OPENSHIFT_WILDFLY_DIR}/bin
cp -r ${OPENSHIFT_WILDFLY_DIR}versions/${version}/* ${OPENSHIFT_WILDFLY_DIR}/

# Initialize the JBoss CLI history file
[ -f ${OPENSHIFT_HOMEDIR}/.jboss-cli-history ] || touch ${OPENSHIFT_HOMEDIR}/.jboss-cli-history

mkdir -p $OPENSHIFT_WILDFLY_DIR/jboss_cfg_backup
cp -n ${OPENSHIFT_WILDFLY_DIR}/versions/${version}/standalone/configuration/standalone.xml $OPENSHIFT_WILDFLY_DIR/jboss_cfg_backup/standalone.xml

getcockpit    ${PLANON_COCKPIT_URL}DatabasePlane/${OPENSHIFT_APP_DNS}/server ${OPENSHIFT_WILDFLY_DIR}env/PLN_DB_SERVER
getcockpit    ${PLANON_COCKPIT_URL}DatabasePlane/${OPENSHIFT_APP_DNS}/username ${OPENSHIFT_WILDFLY_DIR}env/PLN_DB_USERNAME
getcockpit    ${PLANON_COCKPIT_URL}DatabasePlane/${OPENSHIFT_APP_DNS}/password ${OPENSHIFT_WILDFLY_DIR}env/PLN_DB_PASSWORD