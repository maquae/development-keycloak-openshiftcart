#!/bin/bash
# vi: set sw=4 ts=4 ai:

# Determine the program name and the 'running directory'
IAM="${0##*/}"
CRD="$( [[ "${0:0:2}" = "./" ]] &&
	{	printf "${PWD}/${0#./}"
	} || {
		printf "${0}"
	})"
CRD="${CRD%/*}"
CUR="${PWD}"

# Make sure all language settings are correct
export LANG=C

# Save the shell settings
SETA=0; [[ ${-} = *a* ]] && SETA=1
SETE=0; [[ ${-} = *e* ]] && SETE=1
SETU=0; [[ ${-} = *u* ]] && SETU=1
SETX=0; [[ ${-} = *x* ]] && SETX=1

# Set and unset the needed shell settings
set +o noclobber		# Overwrite existing files, if needed
set -o nounset			# Do not allow uninitialized variables
set +o errexit			# No returncode checking

# Read the OpenShift functions
source ${OPENSHIFT_CARTRIDGE_SDK_BASH}


# Get the commandline options
version=""
case "${1}" in
 	-v|--version)
 		version="${2}"
 		;;
esac

# Set constants and read constants
LIBDIR="${CRD}/../lib"
LIBRARY="${LIBDIR}/library"
[[ ! -r ${LIBRARY} ]] && { echo "${LIBRARY} not found"; exit 1; }
. ${LIBRARY} || { echo "Error reading ${LIBRARY}"; exit 1; }


if [[ x"${version}" == x"" ]]
then
	showstatus "0" "Install called without extra version info"
else
	showstatus "0" "Install called with version ${version}"
fi

# Program usage
usage()
{
	T="	"
	cat <<- @EOF
		Usage: ${IAM} [-v version|-h]

		${T}-h 	Shows this help
		${T}-v 	Gives the version number to install
	@EOF

	exit 1
}

case "$1" in
  -v|--version)
    version="10"
esac

echo "$version" > "$OPENSHIFT_PLNKEYCLK_DIR/env/OPENSHIFT_WILDFLY_VERSION"

ln -s ${OPENSHIFT_PLNKEYCLK_DIR}/standalone/log ${OPENSHIFT_PLNKEYCLK_DIR}/logs

#Call library to set jave_home
createEnvVariables

mkdir -p ${OPENSHIFT_PLNKEYCLK_DIR}jdk
mkdir -p ${OPENSHIFT_PLNKEYCLK_DIR}versions

#Download and install correct JDK
getartifact ${DOWNLOAD_FILE_JDK} ${DOWNLOAD_FILE_JDK}
showstatus "0" "JDK downloaded"
extract ${DOWNLOAD_FILE_JDK} ${OPENSHIFT_PLNKEYCLK_DIR}jdk
mv ${OPENSHIFT_PLNKEYCLK_DIR}jdk/jdk1.${JDK_MAJOR}.0_${JDK_MINOR}/* ${OPENSHIFT_PLNKEYCLK_DIR}jdk/
rm -rf ${OPENSHIFT_PLNKEYCLK_DIR}/jdk/jdk1.${JDK_MAJOR}.0_${JDK_MINOR}
rm -f ${DOWNLOAD_FILE_JDK} 
showstatus "0" "JDK installed in ${JAVA_HOME}"

#Download and move Keycloak artifact
getartifact ${DOWNLOAD_FILE_KEYCLOAK} ${DOWNLOAD_FILE_KEYCLOAK}
showstatus "0" "WildFly + Keycloak downloaded"
extract ${DOWNLOAD_FILE_KEYCLOAK} ${OPENSHIFT_PLNKEYCLK_DIR}versions/
rm -f ${DOWNLOAD_FILE_KEYCLOAK}
showstatus "0" "WildFly + Keycloak extracted"

# Create additional directories required by JBOSSAS
mkdir -p ${OPENSHIFT_HOMEDIR}/.m2
mkdir -p ${OPENSHIFT_PLNKEYCLK_DIR}/{template,standalone/tmp,standalone/deployments,standalone/configuration,standalone/log,standalone/data}

# Copy the version specific files up to jbossas directory
cp -r ${OPENSHIFT_PLNKEYCLK_DIR}versions/${version}/standalone/configuration/* ${OPENSHIFT_PLNKEYCLK_DIR}standalone/configuration
cp -r ${OPENSHIFT_PLNKEYCLK_DIR}versions/${version}/bin/* ${OPENSHIFT_PLNKEYCLK_DIR}/bin
cp -r ${OPENSHIFT_PLNKEYCLK_DIR}versions/${version}/* ${OPENSHIFT_PLNKEYCLK_DIR}/

# Initialize the JBoss CLI history file
[ -f ${OPENSHIFT_HOMEDIR}/.jboss-cli-history ] || touch ${OPENSHIFT_HOMEDIR}/.jboss-cli-history

mkdir -p $OPENSHIFT_PLNKEYCLK_DIR/jboss_cfg_backup
cp -n ${OPENSHIFT_PLNKEYCLK_DIR}/versions/${version}/standalone/configuration/standalone.xml $OPENSHIFT_PLNKEYCLK_DIR/jboss_cfg_backup/standalone.xml

shopt -s dotglob
cp -r ${OPENSHIFT_PLNKEYCLK_DIR}/versions/${version}/template/* ${OPENSHIFT_PLNKEYCLK_DIR}/template
cp -r ${OPENSHIFT_PLNKEYCLK_DIR}/versions/${version}/template/.openshift ${OPENSHIFT_PLNKEYCLK_DIR}/template
cp ${OPENSHIFT_PLNKEYCLK_DIR}/standalone/configuration/standalone.xml ${OPENSHIFT_PLNKEYCLK_DIR}/template/.openshift/config/standalone.xml

sed -i "s/{APP_NAME}/${OPENSHIFT_APP_NAME}/g" ${OPENSHIFT_PLNKEYCLK_DIR}/template/pom.xml

username=$(generate_username)
password=$(generate_password)

echo "$username" > $OPENSHIFT_PLNKEYCLK_DIR/env/OPENSHIFT_KEYCLOAK_USERNAME
echo "$password" > $OPENSHIFT_PLNKEYCLK_DIR/env/OPENSHIFT_KEYCLOAK_PASSWORD

#update-configuration java8

#$OPENSHIFT_PLNKEYCLK_DIR/bin/add-user.sh --user ${username} --password ${password}

#client_result ""
#client_result "Keycloak administrator added.  Please make note of these credentials:"
#client_result ""
#client_result "   Username: $username"
#client_result "   Password: $password"
#client_result "   "
#client_result ""

client_result ""
client_result "Keycloak been installed"
client_result ""
client_result ""

#JBOSS_HOME=/etc/alternatives/jbossas-$version
#pushd $OPENSHIFT_PLNKEYCLK_DIR 1> /dev/null
#  ln -s ${JBOSS_HOME}/jboss-modules.jar
#  ln -s ${JBOSS_HOME}/modules
#popd 1> /dev/null

touch ${OPENSHIFT_PLNKEYCLK_DIR}/env/OPENSHIFT_WILDFLY_CLUSTER
#touch ${OPENSHIFT_PLNKEYCLK_DIR}/env/OPENSHIFT_JBOSSAS_CLUSTER_REMOTING

